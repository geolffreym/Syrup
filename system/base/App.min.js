"use strict";(function(window){function Apps(){this.root=null;this.lib=null;this.scope=null;this.lazy=false;this.interceptors={};this.moduleCollection={};this.appCollection={};this.recipeCollection={};this.onchange={}}Apps.add("module",function(name,dependencies){if(!(name in this.moduleCollection)){this.moduleCollection[name]=new Apps;this.moduleCollection[name].root=name;this.moduleCollection[name].moduled=true;this.moduleCollection[name].lib=new LibClass;this.moduleCollection[name].lib.blend(name,dependencies)}return this.moduleCollection[name]});Apps.add("blend",function(name,dependencies){var _self=new Apps;_self.lib=new LibClass;_self.root=name;_self.parent=this.moduled&&this||null;_self.lazy=this.lazy;_self.scope={};_self.body=_$("body");_self.blended=true;if(this.moduled){dependencies=dependencies||[];dependencies.push(this.root);this.appCollection[name]=_self}_self.lib.blend(name,dependencies);return _self});Apps.add("recipe",function(moduleId,module){if(this.root&&this.blended){if(_.isSet(module)){var _self=this;_self.recipeCollection[moduleId]={creator:module,instance:null};if(!this.lazy)_$(function(){_self._taste(moduleId)})}}return this});Apps.add("_watch",function(moduleId){var _self=this;Object.observe(_self.scope,function(change){_.each(change,function(v){if(v.name in _self.onchange&&_.getObjectSize(v.object)>0&&moduleId===v.name){_self.onchange[v.name].call(_self.recipeCollection[moduleId].instance,{name:v.name,old:v.oldValue,type:v.type,object:v.object[v.name]});return false}})})});Apps.add("_add",function(moduleId){if(!_.isObject(this.scope[moduleId])){this.scope[moduleId]={}}});Apps.add("_trigger",function(moduleId){if(moduleId in this.recipeCollection)return this.recipeCollection[moduleId].creator(_,this.scope);return{}});Apps.add("cook",function(callback){if(_.isFunction(callback))callback.call(this,this.lib.get(this.root),_);return this});Apps.add("spice",function(object){if(_.isObject(object))this.lib.make(object);return this});Apps.add("service",function(name,callback){this.lib.cook(name,callback);return this});Apps.add("services",function(object){this.lib.supply(object);return this});Apps.add("_getRecipe",function(moduleId){if(moduleId in this.recipeCollection&&_.isSet(this.root))return this.recipeCollection[moduleId].instance;return null});Apps.add("_setScope",function(moduleId,object){if(moduleId in this.scope){this.scope[moduleId]=object}return this});Apps.add("_getScope",function(moduleId){if(moduleId in this.scope){return this.scope[moduleId]}return{}});Apps.add("when",function(event,name){var self=this;return event&&({change:{then:function(resolve){self.onchange[name]=resolve}}}[event]||{then:function(){}})});Apps.add("_bindListener",function(moduleId){var enabled_events=["[sp-click], ","submit], ","change], ","dblclick], ","mousedown], ","mouseenter], ","mouseleave], ","mousemove], ","mouseover], ","mouseout], ","mouseup], ","keydown], ","keypress], ","keyup], ","blur], ","focus], ","input], ","select], ","reset]"];var _this=this,_dom=null,_self=this.recipeCollection[moduleId].instance,_the_filter=enabled_events.join(" [sp-"),_mod=_$('[sp-recipe="'+moduleId+'"]');if(_mod.exist){_mod.find(_the_filter,function(dom_list){_.each((_dom=dom_list.get()).attributes,function(v){if(/sp-[a-z]+/.test(v.localName)){var _event=_.replace(v.localName,"sp-",_.emptyStr),_attr=_dom.getAttribute(v.localName);if(_attr in _self&&_.isFunction(_self[_attr])){_mod.listen(_event,"["+v.localName+'="'+_attr+'"]',function(e){e.preventDefault();_self[_attr](_this.lib.get(_self.parent),e)})}}})})}});Apps.add("_models",function(moduleId){var _self=this,_model=new Model,_resource=_$('[sp-recipe="'+moduleId+'"] [sp-model]');if(_resource.exist){_self.recipeCollection[moduleId].instance.model={object:_model,resource:_resource,set:function(obj){_model.set(_resource,obj);return _self.recipeCollection[moduleId].instance},get:function(item){return{then:function(resolve){return _model.get(_resource).then(function(e){if(_.isSet(item)&&_.isArray(item)&&!_.isEmpty(item)){var _result={};_.each(item,function(v,i){if(v in e.scope)_result[v]=e.scope[v]});e.scope=_result}resolve.call(_self.recipeCollection[moduleId].instance,e)})}}}}}});Apps.add("_views",function(moduleId){var _self=this;_self.recipeCollection[moduleId].instance.view={render:function(_view,_cache){_self._serve(moduleId,_view||null,_cache||false);return _self.recipeCollection[moduleId].instance}}});Apps.add("_scopes",function(moduleId){var _self=this;_self.recipeCollection[moduleId].instance.scope={global:_self.scope,object:_self.scope[moduleId],set:function(nModule,object){var _moduleId=!_.isObject(nModule)&&_.isString(nModule)&&nModule||moduleId,_object=_.isObject(nModule)&&nModule||object;if(_.isObject(_object)){_self._setScope(_moduleId,_object);return _self.recipeCollection[moduleId].instance}},get:function(nModule){var _moduleId=_.isString(nModule)?nModule:moduleId;return _self._getScope(_moduleId)}}});Apps.add("_app",function(moduleId){var _self=this;_self.recipeCollection[moduleId].instance.app={object:_$("[sp-app]"),title:function(title){var _title=_$("title");if(_title.exist){_title.text(title)}}}});Apps.add("_recipes",function(moduleId){var _self=this;_self.recipeCollection[moduleId].instance.recipe={$:_$('[sp-recipe="'+moduleId+'"]'),get:function(nModule){var _moduleId=_.isString(nModule)?nModule:moduleId;return _self._getRecipe(_moduleId)},drop:function(nModule){var _moduleId=_.isString(nModule)?nModule:moduleId;_self.drop(_moduleId);return _self.recipeCollection[moduleId].instance}}});Apps.add("_serve",function(moduleId,view,cleanCache){var _view=null,_scope=this.scope[moduleId];var _dom=_$('[sp-recipe="'+moduleId+'"] [sp-view]'),_dom_template=_$('[sp-recipe="'+moduleId+'"] [sp-tpl]');if(_dom.exist){if(_.getObjectSize(_scope)>0){_view=new View;if(_.isSet(view)&&_.isString(view)){var view_name=view.split("/").pop(),view_dir=_.replace(view,"/"+view_name,_.emptyStr),view_template_dir="layout/"+view_dir+"/"+view_name;if(/\.html$/.test(view_name)){if(cleanCache)_view.cleanCache(view_template_dir);_view.seekTpl(view_template_dir).then(function(view){view.render(_scope).then(function(res){_dom.html(res)})})}else{Require.lookup(["view/"+view_dir]).then(function(){if(view_name in _view.__proto__)_view[view_name](_,_scope,function(my_html){_dom.html(my_html)})})}}else if(_dom_template.exist){var _parse=_dom_template.html();if(_.isSet(_parse)){_view.render(_parse,_scope).then(function(result){_dom.html(result)})}}}}return this});Apps.add("_taste",function(moduleId){var _self=this;_self._handleInterceptor("taste",_self);if(moduleId in _self.recipeCollection&&_.isSet(_self.root)){_self._add(moduleId);_self.recipeCollection[moduleId].instance=_self._trigger(moduleId);_self.recipeCollection[moduleId].instance.name=moduleId;_self.recipeCollection[moduleId].instance.parent=_self.root;_self.recipeCollection[moduleId].instance.when=function(event){return _self.when(event,moduleId)};_self._recipes(moduleId);_self._scopes(moduleId);_self._models(moduleId);_self._app(moduleId);_self._views(moduleId);if("init"in _self.recipeCollection[moduleId].instance&&_.isFunction(_self.recipeCollection[moduleId].instance.init)){_self._handleInterceptor("init",_self.recipeCollection[moduleId].instance);_self.recipeCollection[moduleId].instance.init(_self.lib.get(_self.root))}_self._bindListener(moduleId);_self._watch(moduleId)}return this});Apps.add("taste",function(moduleId){var _self=this,_moduleId=moduleId&&[moduleId]||_.getObjectKeys(_self.recipeCollection);_self.lazy=false;_.each(_moduleId,function(v){_self._taste(v)});return this});Apps.add("intercept",function(interceptors){if(_.isObject(interceptors))MiddleWare.intercept(this,interceptors);return this});Apps.add("_handleInterceptor",function(type,param){MiddleWare.trigger(MiddleWare.getInterceptors(this,type),[param,this]);MiddleWare.cleanInterceptor(this,type)});Apps.add("drop",function(moduleId){if(moduleId in this.recipeCollection){if(this.recipeCollection[moduleId].instance){if("destroy"in this.recipeCollection[moduleId].instance)this.recipeCollection[moduleId].instance.destroy(this.lib.get(this.root));this.recipeCollection[moduleId]=null}}return this});Apps.add("dropAll",function(){var _self=this;_.each(this.recipeCollection,function(module,id){_self.drop(id)});return this});window.App=new Apps;window.AppClass=Apps})(window);