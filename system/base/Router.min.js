(function(window){"use strict";function Router(){this.routes={};this.history=window.history;this.findParams=/(:[\w]+)/g;this.onpopstate={};var _self=this;window.addEventListener("popstate",function(e){if(_.isSet(e.state)&&"route_name"in e.state){if(e.state.route_name in _self.onpopstate){_.each(_self.onpopstate[e.state.route_name],function(v,i){v(e.state,e)},true)}}})}Router.add("set",function(routes){var _self=this;return new Promise(function(resolve,reject){_self.routes=_.extend(_self.routes,routes);resolve(_self)})});Router.add("_handleSkull",function(tpl,callback,params){var _view=new View;_view.clear();_view.seekTpl(tpl).then(function(view){var _main=_$("[sp-app]");if(_main.exist)_main.html(view.getTpl());callback.apply(null,params)})});Router.add("when",function(route_name,conf){_.assert(route_name,_.WARNING_SYRUP.ERROR.NOPARAM,"(Router .when)");var _self=this;return{then:function(callback){if(_.isFunction(callback)){if(!(route_name in _self.onpopstate))_self.onpopstate[route_name]=[];_self.onpopstate[route_name].push(function(state,e){if(conf&&"tpl"in conf){_self._handleSkull(conf.tpl,callback,[state,e])}else{callback(state,e)}});if(_.matchInArray(route_name,["home","default","init","initial"])){_self.redirect(route_name,{})}}return _self}}});Router.add("redirect",function(route_name,params,config){_.assert(route_name,_.WARNING_SYRUP.ERROR.NOPARAM,"(Router .redirect)");var _self=this,_the_new_route=null,_params=null,_config={trigger:true};return new Promise(function(resolve,reject){if(!(route_name in _self.routes)){reject(route_name);return}_params=_.isObject(params)?params:{};_config=_.extend(_config,config||{},true);_params["route_name"]=route_name;_the_new_route=_self.routes[route_name];_the_new_route=_.isSet(params)&&_.getObjectSize(params)>0?_.replace(_the_new_route,_self.findParams,params):_the_new_route;_self._triggerPopState(_params,route_name,_the_new_route,_config);resolve(_the_new_route)})});Router.add("_triggerPopState",function(_params,route_name,_the_new_route,_config){if(_config.trigger){this.history.pushState(_params,route_name,_the_new_route);this.history.pushState(_params,route_name,_the_new_route);this.history.back()}});window.Router=new Router;window.RouterClass=Router})(window);